<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Find your Parking spot - Deniz PWA</title>
  <link type="text/css" href="/css/styles.css" rel="stylesheet">
  <link rel="manifest" href="/manifest.json">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body style="width: 80%; margin: auto; background-color:#43CEE1">
  <div style="text-align: center; width: 80%; margin: auto;">
    <h1>Find and Safe your Parkingspot!</h1>
    <div>
    </div>
    <h4> it here:</h4>
    <div >
      <a href="createImage.html" ><img style="padding: 10px;" src="/Parkplatz72.png" alt="add new image"
        title="add new image"></a>
    </div>    
  </div>
  <div id="map"></div>
  <script async="false" type="text/javascript"
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvCH2ZUreUkYasJU3g7ykiVbGtOHArJ-A&callback=initMap"></script>
  <script src="/js/app.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.4.0/firebase-app.js";

    import {
      getFirestore, collection, getDocs,
      addDoc, deleteDoc, doc, GeoPoint
    } from 'https://www.gstatic.com/firebasejs/9.4.0/firebase-firestore.js';

    const firebaseConfig = {
  apiKey: "AIzaSyDvCH2ZUreUkYasJU3g7ykiVbGtOHArJ-A",
  authDomain: "testpwa-336611.firebaseapp.com",
  projectId: "testpwa-336611",
  storageBucket: "testpwa-336611.appspot.com",
  messagingSenderId: "692584001354",
  appId: "1:692584001354:web:50fabc2c2af19e141c9bb3"
};

    initializeApp(firebaseConfig)

    const db = getFirestore()

    const colRef = collection(db, 'Photos')

    getDocs(colRef)
      .then((snapshot) => {
        let photos = []
        snapshot.docs.forEach((doc) => {
          if(doc.data().check == true){
            addMarker({ lat: doc.data().position.latitude, lng: doc.data().position.longitude }, doc.data().url, doc.data().name, doc.data().date)
          }
          else{
            addMarker2({ lat: doc.data().position.latitude, lng: doc.data().position.longitude }, doc.data().url, doc.data().name,doc.data().date)
          }
          
        })
        console.log()
      })
      .catch(err => {
        console.log(err.message)
      })

      
    var options = {
      zoom: 8,
      minZoom: 3,
      center: {
        lat: 50.110924,
        lng: 8.682127
      }
    }
    var map = new
      google.maps.Map(document.getElementById('map'), options);

    //add marker function
    function addMarker(coords, picture, name, date) {
      var marker = new google.maps.Marker({
        position: coords,
        //animation: google.maps.Animation.DROP,
        icon: '/mycar.png',
        map: map,
      });
      var infowindow = new google.maps.InfoWindow({
        maxWidth: 150,
        content: `<img src="${picture}" style="width: 120px; height: 100px;">
                     <h4 style="text-align: center;">"Name: "${name}</h4>
                     <h4 style="text-align: center;">"Datum/Uhr: "${date}</h4>`,
      })

      //infowindow.open(map, marker);

      marker.addListener("click", () => {
        infowindow.open({
          anchor: marker,
          map,
        });
      });
    }
    //add marker function
    function addMarker2(coords, picture, name, date) {
      var marker = new google.maps.Marker({
        position: coords,
        icon: '/parking.png',
        //animation: google.maps.Animation.DROP,
        map: map,
      });
      var infowindow = new google.maps.InfoWindow({
        maxWidth: 150,
        content: `<img src="${picture}" style="width: 120px; height: 100px;">
                     <h4 style="text-align: center;">"Name: "${name}</h4>
                     <h4 style="text-align: center;">"Datum/Uhr: "${date}</h4>`,
      })

      //infowindow.open(map, marker);

      marker.addListener("click", () => {
        infowindow.open({
          anchor: marker,
          map,
        });
      });
    }

    let infoWindow = new google.maps.InfoWindow();
    const locationButton = document.createElement("button");

  locationButton.textContent = "Pan to Current Location";
  locationButton.classList.add("custom-map-control-button");
  map.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);
  locationButton.addEventListener("click", () => {
    // Try HTML5 geolocation.
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };

          infoWindow.setPosition(pos);
          infoWindow.setContent("Location found.");
          infoWindow.open(map);
          map.setCenter(pos);
        },
        () => {
          handleLocationError(true, infoWindow, map.getCenter());
        }
      );
    } else {
      // Browser doesn't support Geolocation
      handleLocationError(false, infoWindow, map.getCenter());
    }
  });


function handleLocationError(browserHasGeolocation, infoWindow, pos) {
  infoWindow.setPosition(pos);
  infoWindow.setContent(
    browserHasGeolocation
      ? "Error: The Geolocation service failed."
      : "Error: Your browser doesn't support geolocation."
  );
  infoWindow.open(map);
}
  </script>
</body>
</html>